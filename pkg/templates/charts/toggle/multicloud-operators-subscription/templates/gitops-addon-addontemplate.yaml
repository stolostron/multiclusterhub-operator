apiVersion: addon.open-cluster-management.io/v1alpha1
kind: AddOnTemplate
metadata:
  name: gitops-addon
spec:
  addonName: gitops-addon
  agentSpec:
    workload:
      manifests:
      - apiVersion: batch/v1
        kind: Job
        metadata:
          annotations:
            addon.open-cluster-management.io/addon-pre-delete: ''
          labels:
            apps.open-cluster-management.io/gitopsaddon: 'true'
          name: gitops-addon-cleanup
          namespace: open-cluster-management-agent-addon
        spec:
          activeDeadlineSeconds: 600
          backoffLimit: 3
          template:
            spec:
              containers:
              - args:
                - -cleanup
                command:
                - /usr/local/bin/gitopsaddon
                image: '{{ .Values.global.imageOverrides.multicloud_integrations }}'
                imagePullPolicy: IfNotPresent
                name: cleanup
              restartPolicy: Never
              serviceAccountName: gitops-addon
      - apiVersion: apps/v1
        kind: Deployment
        metadata:
          labels:
            app: gitops-addon
            apps.open-cluster-management.io/gitopsaddon: 'true'
          name: gitops-addon
          namespace: open-cluster-management-agent-addon
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: gitops-addon
          template:
            metadata:
              annotations:
                target.workload.openshift.io/management: '{"effect": "PreferredDuringScheduling"}'
              labels:
                app: gitops-addon
            spec:
              containers:
              - command:
                - /usr/local/bin/gitopsaddon
                env:
                - name: GITOPS_OPERATOR_IMAGE
                  value: '{{ `{{GITOPS_OPERATOR_IMAGE}}` }}'
                - name: ARGOCD_IMAGE
                  value: '{{ `{{ARGOCD_IMAGE}}` }}'
                - name: ARGOCD_REPOSERVER_IMAGE
                  value: '{{ `{{ARGOCD_REPOSERVER_IMAGE}}` }}'
                - name: ARGOCD_REDIS_IMAGE
                  value: '{{ `{{ARGOCD_REDIS_IMAGE}}` }}'
                - name: ARGOCD_REDIS_HA_IMAGE
                  value: '{{ `{{ARGOCD_REDIS_HA_IMAGE}}` }}'
                - name: ARGOCD_REDIS_HA_PROXY_IMAGE
                  value: '{{ `{{ARGOCD_REDIS_HA_PROXY_IMAGE}}` }}'
                - name: ARGOCD_DEX_IMAGE
                  value: '{{ `{{ARGOCD_DEX_IMAGE}}` }}'
                - name: BACKEND_IMAGE
                  value: '{{ `{{BACKEND_IMAGE}}` }}'
                - name: GITOPS_CONSOLE_PLUGIN_IMAGE
                  value: '{{ `{{GITOPS_CONSOLE_PLUGIN_IMAGE}}` }}'
                - name: ARGOCD_EXTENSION_IMAGE
                  value: '{{ `{{ARGOCD_EXTENSION_IMAGE}}` }}'
                - name: ARGO_ROLLOUTS_IMAGE
                  value: '{{ `{{ARGO_ROLLOUTS_IMAGE}}` }}'
                - name: ARGOCD_IMAGE_UPDATER_IMAGE
                  value: '{{ `{{ARGOCD_IMAGE_UPDATER_IMAGE}}` }}'
                - name: ARGOCD_AGENT_IMAGE
                  value: '{{ `{{ARGOCD_AGENT_IMAGE}}` }}'
                - name: HTTP_PROXY
                  value: '{{ `{{HTTP_PROXY}}` }}'
                - name: HTTPS_PROXY
                  value: '{{ `{{HTTPS_PROXY}}` }}'
                - name: NO_PROXY
                  value: '{{ `{{NO_PROXY}}` }}'
                - name: ARGOCD_AGENT_ENABLED
                  value: '{{ `{{ARGOCD_AGENT_ENABLED}}` }}'
                - name: ARGOCD_AGENT_SERVER_ADDRESS
                  value: '{{ `{{ARGOCD_AGENT_SERVER_ADDRESS}}` }}'
                - name: ARGOCD_AGENT_SERVER_PORT
                  value: '{{ `{{ARGOCD_AGENT_SERVER_PORT}}` }}'
                - name: ARGOCD_AGENT_MODE
                  value: '{{ `{{ARGOCD_AGENT_MODE}}` }}'
                image: '{{ .Values.global.imageOverrides.multicloud_integrations }}'
                imagePullPolicy: IfNotPresent
                name: gitops-addon
                securityContext:
                  allowPrivilegeEscalation: false
                  capabilities:
                    drop:
                    - ALL
                  readOnlyRootFilesystem: true
                  runAsNonRoot: true
                volumeMounts:
                - mountPath: /tmp
                  name: tmp-volume
              serviceAccountName: gitops-addon
              volumes:
              - emptyDir: {}
                name: tmp-volume
      - apiVersion: v1
        imagePullSecrets:
        - name: open-cluster-management-image-pull-credentials
        kind: ServiceAccount
        metadata:
          labels:
            apps.open-cluster-management.io/gitopsaddon: 'true'
          name: gitops-addon
          namespace: open-cluster-management-agent-addon
      - apiVersion: rbac.authorization.k8s.io/v1
        kind: ClusterRoleBinding
        metadata:
          labels:
            apps.open-cluster-management.io/gitopsaddon: 'true'
          name: gitops-addon
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: ClusterRole
          name: cluster-admin
        subjects:
        - kind: ServiceAccount
          name: gitops-addon
          namespace: open-cluster-management-agent-addon
