
# Source: flightctl/templates/flightctl-secrets-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: flightctl-secrets
  namespace: PLACEHOLDER_NAMESPACE
spec:
  manualSelector: true
  selector:
    matchLabels:
      flightctl.service: secrets-job
  template:
    metadata:
      name: flightctl-secrets
      labels:
        flightctl.service: secrets-job
    spec:
      serviceAccountName: flightctl-secrets
      containers:
        - name: flightctl-secrets
          image: quay.io/openshift/origin-cli:4.20.0
          imagePullPolicy: Always
          command:
            - /bin/sh
            - -c
            - |
              set -e
              DB_PASSWORD=$(cat /dev/urandom | tr -dc 'A-Za-z0-90-9' | fold -w5 | head -n4 | paste -sd'-')
              DB_MASTER_PASSWORD=$(cat /dev/urandom | tr -dc 'A-Za-z0-90-9' | fold -w5 | head -n4 | paste -sd'-')
              DB_USER_PASSWORD=$(cat /dev/urandom | tr -dc 'A-Za-z0-90-9' | fold -w5 | head -n4 | paste -sd'-')
              KV_PASSWORD=$(cat /dev/urandom | tr -dc 'A-Za-z0-90-9' | fold -w5 | head -n4 | paste -sd'-')
              if ! oc get secret flightctl-db-secret -n PLACEHOLDER_NAMESPACE >/dev/null 2>&1; then
                oc create secret generic flightctl-db-secret -n=PLACEHOLDER_NAMESPACE --from-literal=password="$DB_PASSWORD" --from-literal=masterPassword="$DB_MASTER_PASSWORD" --from-literal=masterUser="admin" --from-literal=userPassword="$DB_USER_PASSWORD" --from-literal=user="demouser"
              fi
              if ! oc get secret flightctl-kv-secret -n PLACEHOLDER_NAMESPACE >/dev/null 2>&1; then
                oc create secret generic flightctl-kv-secret -n=PLACEHOLDER_NAMESPACE --from-literal=password="$KV_PASSWORD"
              fi
      restartPolicy: Never
