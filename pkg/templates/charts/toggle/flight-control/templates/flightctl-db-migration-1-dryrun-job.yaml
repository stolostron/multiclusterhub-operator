apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    helm.sh/hook: pre-upgrade
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
    helm.sh/hook-weight: '-10'
  labels:
    app: flightctl-db-migration
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: flightctl
    app.kubernetes.io/version: latest
    flightctl.io/migration-revision: '1'
    helm.sh/chart: flightctl-0.1.0
    release: release-name
  name: flightctl-db-migration-1-dryrun
  namespace: '{{ default "''{{ .Values.global.namespace }}''" .Values.global.namespace }}'
spec:
  backoffLimit: 2147483647
  completions: 1
  parallelism: 1
  template:
    metadata:
      labels:
        app: flightctl-db-migration
        app.kubernetes.io/instance: release-name
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: flightctl
        app.kubernetes.io/version: latest
        flightctl.io/migration-revision: '1'
        helm.sh/chart: flightctl-0.1.0
        release: release-name
    spec:
      containers:
      - command:
        - /bin/bash
        - -c
        - 'set -eo pipefail

          echo "Running database migrations..."


          # Copy config file to a writable location

          mkdir -p /tmp/.flightctl

          cp /root/.flightctl/config.yaml /tmp/.flightctl/config.yaml

          export HOME=/tmp


          /usr/local/bin/flightctl-db-migrate --dry-run

          echo "Migrations completed successfully!"

          '
        env:
        - name: HOME
          value: /root
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              key: migrationUser
              name: flightctl-db-migration-secret
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              key: migrationPassword
              name: flightctl-db-migration-secret
        - name: DB_MIGRATION_USER
          valueFrom:
            secretKeyRef:
              key: migrationUser
              name: flightctl-db-migration-secret
        - name: DB_MIGRATION_PASSWORD
          valueFrom:
            secretKeyRef:
              key: migrationPassword
              name: flightctl-db-migration-secret
        - name: DB_APP_USER
          valueFrom:
            secretKeyRef:
              key: user
              name: flightctl-db-app-secret
        - name: DB_APP_PASSWORD
          valueFrom:
            secretKeyRef:
              key: userPassword
              name: flightctl-db-app-secret
        - name: DB_ADMIN_USER
          valueFrom:
            secretKeyRef:
              key: masterUser
              name: flightctl-db-admin-secret
        - name: DB_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              key: masterPassword
              name: flightctl-db-admin-secret
        image: '{{ .Values.global.imageOverrides.flightctl_db_setup }}'
        imagePullPolicy: '{{ .Values.global.pullPolicy }}'
        name: run-migrations
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          privileged: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
        volumeMounts:
        - mountPath: /root/.flightctl/
          name: flightctl-db-migration-config
          readOnly: true
      initContainers:
      - command:
        - /app/deploy/scripts/wait-for-database.sh
        - --timeout=120
        env:
        - name: DB_USER_TYPE
          value: admin
        - name: DB_HOST
          value: flightctl-db.'{{ .Values.global.namespace }}'.svc.cluster.local
        - name: DB_PORT
          value: '5432'
        - name: DB_NAME
          value: flightctl
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              key: masterUser
              name: flightctl-db-admin-secret
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              key: masterPassword
              name: flightctl-db-admin-secret
        image: '{{ .Values.global.imageOverrides.flightctl_db_setup }}'
        imagePullPolicy: '{{ .Values.global.pullPolicy }}'
        name: wait-for-database-admin
        volumeMounts: null
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: flightctl-db-migration
      volumes:
      - configMap:
          name: flightctl-db-migration-config
        name: flightctl-db-migration-config
